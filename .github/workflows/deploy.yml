name: Deploy to VPS Hostinger

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '82.25.69.57'
  VPS_USER: 'root'
  APP_DIR: '/opt/supabase-baas'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.VPS_HOST }}
        username: ${{ env.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 300s
        command_timeout: 300s
        envs: GITHUB_TOKEN
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        script: |
          # NÃ£o usar set -e no inÃ­cio para permitir diagnÃ³sticos
          
          echo "ğŸš€ Iniciando deploy do Supabase BaaS..."
          
          # Configurar diretÃ³rio do projeto
          APP_DIR="${{ env.APP_DIR }}"
          
          # FunÃ§Ã£o de log
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }
          
          # Diagnosticar conectividade
          log "ğŸ” Verificando conectividade..."
          ping -c 3 github.com || log "âš ï¸  Ping para GitHub falhou"
          nslookup github.com || log "âš ï¸  DNS lookup falhou"
          curl -I https://github.com || log "âš ï¸  HTTPS para GitHub falhou"
          
          # Configurar Git globalmente
          log "âš™ï¸  Configurando Git..."
          git config --global user.name "Deploy Bot" || true
          git config --global user.email "deploy@github.com" || true
          git config --global init.defaultBranch main || true
          
          # Certificados SSL
          log "ğŸ” Atualizando certificados SSL..."
          apt-get update -qq || true
          apt-get install -y ca-certificates curl git || true
          update-ca-certificates || true
          
          log "ğŸ“ Preparando diretÃ³rio: $APP_DIR"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          # Verificar se Ã© um repositÃ³rio git, se nÃ£o, clonar
          if [ ! -d ".git" ]; then
            log "ğŸ“¥ Clonando repositÃ³rio..."
            
            # Tentar mÃºltiplas abordagens
            if ! git clone https://github.com/fernandinhomartins40/backsupa.git . 2>/dev/null; then
              log "âš ï¸  Clone HTTPS falhou, tentando com --depth 1..."
              if ! git clone --depth 1 https://github.com/fernandinhomartins40/backsupa.git . 2>/dev/null; then
                log "âš ï¸  Clone com depth falhou, tentando baixar via curl..."
                curl -L https://github.com/fernandinhomartins40/backsupa/archive/main.tar.gz | tar xz --strip-components=1
                git init .
                git remote add origin https://github.com/fernandinhomartins40/backsupa.git
                git add .
                git commit -m "Initial commit from deploy"
              fi
            fi
            
            log "âœ… RepositÃ³rio clonado com sucesso"
          fi
          
          # Parar containers existentes
          log "â¹ï¸ Parando containers existentes..."
          docker compose -f docker/docker-compose.production.yml down --remove-orphans || true
          
          # Backup da versÃ£o anterior (opcional)
          if [ -d "backup" ]; then
            rm -rf backup.old || true
            mv backup backup.old || true
          fi
          mkdir -p backup
          
          # Atualizar cÃ³digo
          log "ğŸ”„ Atualizando cÃ³digo..."
          git config --global --add safe.directory $APP_DIR
          
          # Se jÃ¡ existe repositÃ³rio, atualizar
          if [ -d ".git" ]; then
            # Verificar se remote origin existe
            if ! git remote get-url origin >/dev/null 2>&1; then
              git remote add origin https://github.com/fernandinhomartins40/backsupa.git
            fi
            
            # Tentar atualizar
            if ! git fetch origin 2>/dev/null; then
              log "âš ï¸  Fetch falhou, removendo e clonando novamente..."
              cd ..
              rm -rf $APP_DIR
              mkdir -p $APP_DIR
              cd $APP_DIR
              git clone https://github.com/fernandinhomartins40/backsupa.git . || {
                log "âŒ Clone falhou, baixando via curl..."
                curl -L https://github.com/fernandinhomartins40/backsupa/archive/main.tar.gz | tar xz --strip-components=1
              }
            else
              git reset --hard origin/main
              git clean -fd
            fi
          fi
          
          # Verificar se o cÃ³digo foi baixado com sucesso
          log "âœ… Verificando se o repositÃ³rio foi baixado..."
          if [ ! -f "package.json" ] && [ ! -f "docker/docker-compose.production.yml" ]; then
            log "âŒ RepositÃ³rio nÃ£o foi baixado corretamente!"
            ls -la
            exit 1
          fi
          log "âœ… RepositÃ³rio verificado com sucesso!"
          
          # Ativar exit on error apÃ³s download
          set -e
          
          # Verificar dependÃªncias
          log "ğŸ” Verificando dependÃªncias..."
          
          # Instalar Docker se nÃ£o existir
          if ! command -v docker &> /dev/null; then
            log "ğŸ“¦ Instalando Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl start docker
            systemctl enable docker
            usermod -aG docker $USER
          fi
          
          # Verificar Docker Compose
          if ! docker compose version &> /dev/null; then
            log "ğŸ“¦ Docker Compose nÃ£o encontrado. Tentando instalar plugin..."
            apt-get update
            apt-get install -y docker-compose-plugin
          fi
          
          # Verificar se docker-compose de produÃ§Ã£o existe
          if [ ! -f "docker/docker-compose.production.yml" ]; then
            log "âŒ Arquivo docker/docker-compose.production.yml nÃ£o encontrado!"
            exit 1
          fi
          
          # Verificar se arquivos necessÃ¡rios existem
          log "ğŸ” Verificando arquivos necessÃ¡rios..."
          
          REQUIRED_FILES="docker/control-api/Dockerfile docker/billing-system/billing-api/Dockerfile docker/billing-system/marketplace/Dockerfile docker/nginx-config/nginx.conf"
          for file in $REQUIRED_FILES; do
            if [ ! -f "$file" ]; then
              log "âŒ Arquivo necessÃ¡rio nÃ£o encontrado: $file"
              exit 1
            fi
          done
          
          # Configurar permissÃµes
          chmod +x docker/scripts/*.sh 2>/dev/null || true
          chmod +x scripts/deploy/*.sh 2>/dev/null || true
          
          # Limpar containers e imagens antigas
          log "ğŸ§¹ Limpando containers antigos..."
          docker system prune -f --volumes || true
          
          # Iniciar aplicaÃ§Ã£o
          log "ğŸš€ Iniciando aplicaÃ§Ã£o..."
          COMPOSE_FILE="docker/docker-compose.production.yml"
          
          docker compose -f $COMPOSE_FILE up -d --build --remove-orphans
          
          # Aguardar containers iniciarem
          log "â³ Aguardando containers iniciarem..."
          sleep 30
          
          # Verificar status
          log "âœ… Verificando status dos containers..."
          docker compose -f $COMPOSE_FILE ps
          
          # Health checks
          log "ğŸ¥ Executando health checks..."
          
          # Verificar se containers estÃ£o rodando
          FAILED_SERVICES=""
          
          for service in supabase_master_db supabase_control_api supabase_billing_api supabase_marketplace_api supabase_nginx; do
            if ! docker ps --format "{{.Names}}" | grep -q "^$service$"; then
              FAILED_SERVICES="$FAILED_SERVICES $service"
              log "âŒ ServiÃ§o $service nÃ£o estÃ¡ rodando"
            else
              log "âœ… ServiÃ§o $service estÃ¡ rodando"
            fi
          done
          
          # Verificar endpoints
          sleep 10
          
          # Test nginx
          if curl -f http://localhost/health >/dev/null 2>&1; then
            log "âœ… Nginx: Respondendo"
          else
            log "âŒ Nginx: NÃ£o estÃ¡ respondendo"
            FAILED_SERVICES="$FAILED_SERVICES nginx"
          fi
          
          # Test control API
          if curl -f http://localhost:3001/health >/dev/null 2>&1; then
            log "âœ… Control API: Respondendo"
          else
            log "âŒ Control API: NÃ£o estÃ¡ respondendo"
            FAILED_SERVICES="$FAILED_SERVICES control-api"
          fi
          
          # Test billing API (assumindo endpoint similar)
          if curl -f http://localhost:3002/health >/dev/null 2>&1; then
            log "âœ… Billing API: Respondendo"
          else
            log "âŒ Billing API: NÃ£o estÃ¡ respondendo"
            FAILED_SERVICES="$FAILED_SERVICES billing-api"
          fi
          
          # Test marketplace API (assumindo endpoint similar) 
          if curl -f http://localhost:3003/health >/dev/null 2>&1; then
            log "âœ… Marketplace API: Respondendo"
          else
            log "âŒ Marketplace API: NÃ£o estÃ¡ respondendo"
            FAILED_SERVICES="$FAILED_SERVICES marketplace-api"
          fi
          
          # Mostrar logs se houver falhas
          if [ -n "$FAILED_SERVICES" ]; then
            log "âŒ ServiÃ§os com falha:$FAILED_SERVICES"
            log "ğŸ“‹ Ãšltimos logs dos containers:"
            docker compose -f $COMPOSE_FILE logs --tail=20
            
            log "ğŸ”„ Tentativa de restart dos serviÃ§os com falha..."
            docker compose -f $COMPOSE_FILE restart
            sleep 20
            
            # Verificar novamente
            docker compose -f $COMPOSE_FILE ps
          else
            log "ğŸ‰ Deploy concluÃ­do com sucesso!"
            log "ğŸŒ Acesse: http://${{ env.VPS_HOST }}"
            log "ğŸ”§ Control API: http://${{ env.VPS_HOST }}:3001"
            log "ğŸ’³ Billing API: http://${{ env.VPS_HOST }}:3002"
            log "ğŸª Marketplace API: http://${{ env.VPS_HOST }}:3003"
          fi
          
          # Log final
          log "ğŸ“Š Resumo do Deploy:"
          echo "- Host: ${{ env.VPS_HOST }}"
          echo "- DiretÃ³rio: $APP_DIR"
          echo "- Containers ativos: $(docker ps --format '{{.Names}}' | wc -l)"
          echo "- Data: $(date)"
          
          log "âœ¨ Deploy finalizado!"